# Introduction

Image inpainting aims to plausibly restore missing pixels within a given hole region. Existing single image inpainting models [65,59,66] solve this problem without additional information by leveraging the knowledge learned from large scale training data or existing patches within the image. These methods become less reliable when input images contains large holes and the filling regions are complex in structures and textures.

In 2021, Zhou et al. [80] proposed a novel inpainting task called reference-based image inpainting. It aims at filling the hole regions of a "target" image using another single source photo taken of the same scene. This foreground re-Figure 1: Given a reference image and a target image with hole, GeoFill utilizes predicted correspondence matching and depth maps to estimate a 3D mesh and relative camera pose and intrinsics. Compared to TransFill, the previous state-of-the-art approach, GeoFill handles complex scenes better by iteratively refining predicted depth maps and relative pose. moval application is particularly useful when people take photos at museums or famous landmarks where the background is unique. It is nearly impossible for existing single image inpainting to faithfully restore what was actually there in the background for such cases. Inpainting with a reference image is appealing and indispensable, and also feasible, since other photos taken at different viewpoints of the same scene can be available, e.g. in the users' albums or even downloaded from the Internet.

However, reference-based image inpainting is very challenging and not well explored. That is because referencebased inpainting is a photography-oriented task that has only one single reference frame as "source", and has usually large baseline or challenging camera movements between the target and source. Therefore, the target and source images cannot be easily aligned to fill in the hole due to issues such as parallax. To address the alignment problems, the previous state-of-the-art method TransFill [80] has a strong assumption that the scenes can be blended by multiple planar structures. It clusters the predicted depth on matched feature points and utilizes multiple homographies to fill the hole. However, real scenes rarely consist of only a few planar surfaces, and even when they do, it can be hard to iden-Figure 2: Overview of our system pipeline. We are given a target image with a hole and a source image. We aim at warping the single-source image to the target to fill the hole. We first estimate the relative pose as well as predict the monocular depth of the source, and then adjust the scale and offset of the depth map. After that, to mitigate the potential errors caused by deep models, we jointly optimize camera relative pose and depth map scale and offset to make the depth map and image contents well-align near the hole region. Finally, we render the reprojected source and refine it using post-processing. tify the relevant planar surfaces. This indicates that to better solve the problem of reference-based inpainting, it is crucial to understand the camera positions and geometry of the 3D scene, especially near the hole region in order to find the appropriate content for hole filling.

In this work, we propose a more principled approach that fills the hole region by explicitly estimating the 3D scene structure from two limited views. Specifically, we first estimate sparse feature correspondences, from which we derive an initial relative pose between the two views. We then predict a monocular dense depth map of the source image and determine a scale and offset that aligns the depth map with the target using a sparse 3D triangulated point cloud. To mitigate the prediction errors and improve alignment accuracy, we next jointly optimize the depth scale and offset and the relative pose using a fast differentiable 3D reprojection of the source image to the target. We synthesize a warped source image by rendering a textured source mesh with the optimized depth and target pose, and fill dis-occluded regions with single image inpainting. Lastly, we adjust the exposure, white balance, lighting, and correct any residual misalignments before pasting the result back into the hole region.

In summary, our GeoFill is the first to apply a more principled approach for reference-based inpainting, i.e., the first to leverage an explicit non-planar 3D scene representation given only limited two-view RGB images (no camera pose information). Compared with the previous state-of-the-art, GeoFill better handles complex 3D scene structures within the hole, wide-baseline image pairs and larger holes. Extensive experiments demonstrate that our methods achieve the best perceptual quality on various scenes in benchmarks and real user cases.

# Related Work

Image inpainting. Traditional image inpainting models rely on hand-crafted heuristics. Diffusion-based approaches [6] propagate pixel colors from the background to the hole region. These approaches generate artifacts when the hole size is large or texture variations are significant. Alternatively, patch-based approaches [57,3] search for similar patches outside the hole region to complete the missing regions. Although these approaches offer high quality texture by copying texture patches, the filled regions may be inconsistent with regions around the hole due to lack of high-level structural understanding of the entire image.

Recent deep models fill the hole by learning from large amounts of training data. Context encoders [42] generate semantically plausible content in the hole by encoding the surroundings. Iizuka et al. [26] adopt two discriminators to ensure the inpainted content is both locally and globally consistent. Artifacts can be reduced along the hole boundary by filtering using partial [32] or gated [66] convolutions. Some recent inpainting models improve the generated image quality with additional information, such as edges [39], segmentation masks [51], and low frequency structures [47,31]. Moreover, several papers show deep neural networks can fill holes on high resolution images [62,64,68]. Despite the significant advancements in single inpainting models, filling with one single image remains fundamentally an ill-posed problem [76]. Image inpainting with additional information is also explored in the literature, such as inpainting with stereo images [55,7,2,38,37] and utilizing more than one image [52]. TransFill [80] is closely related to our work: it performs reference-guided inpainting by warping a reference image with multiple homographies. However, due to the planar nature of homographies, TransFill has a limited ability to handle image pairs with complex 3D struc-tures, wide baselines, or significant disocclusions.

Video Inpainting. Classical works mainly focus on globally optimizing patch-based energies [43,58,19]. Recent work often adopts deep generative models for better inpainting performance. Wang et al. introduce a datadriven framework that jointly learns temporal structure and spatial details [53]. Onion-Peel Network (OPN) proposes to fill in the missing region progressively with the spatiotemporal attention [40]. Spatial-Temporal Transformer Network (STTN) adopts a deep generative model with adversarial training along the spatial-temporal dimension to mitigate blurriness and temporal artifacts [67]. Note that video inpainting approaches heavily exploit the dense temporal information in the video while we only have one single reference image which is a much harder scenario.

Two-view Geometry. SfM establishes correspondences between two monocular frames and subsequently estimates 3D structure [21,50,78,54,36]. In classic geometric vision, it is well understood that the camera poses as well as depth for corresponding points can be computed from feature matching points alone [33,23]. Traditional methods utilize hand-crafted descriptors [34,5,48] to build sparse correspondence for the subsequent fundamental matrix estimation with the 8-point algorithm [22]. Learned local features have shown great success in recent works [63,13,14] together with the learning-based feature matching models, such as SuperGlue [49] or differentiable formations of RANSAC [8,45,9]. Another alternative is to directly estimate relative pose using an end-to-end pose estimation network [27]. We leverage these recent advances (specifically OANet [69]). Our method uses components inspired by SfM, however, our differentiable joint optimization stage is novel and has been carefully formulated for our task.

Monocular Depth Estimation. Predicting depth from a single image is an ill-posed problem. However, learning based approaches have shown impressive performance by either treating monocular depth estimation as a regression or classification task [16,28,60,20,61,18,24,1,29,75,25,74]. Recent advances include BTS [29], which introduces local planar guidance layers to guide the features to full resolution instead of standard upsampling layers during the decoding phase. DAV [25] proposes to exploit the coplanarity of objects in the scene via depth-attention volume. DPT [44] leverages the high quality intermediate representation from transformers and become state-of-the-art.

# Method

Suppose we are given a target image I t with a hole M to be filled, and a reference (source) image I s of the same scene. Our goal is to find a 3D-aware warped source image I s→t that geometrically aligns the source image to the target image which can be used to fill the hole. The final composite image can be represented as

, where M single is the blending map to merge the warped source with the single image inpainting result I single . Note that ideally there should be enough contents that GeoFill can copy from the source image to the target hole region, i.e. the source image I s is useful. Cases with very few targetsource content pixels overlapping inside the hole will cause GeoFill to fall back to the single image inpainting I single .

To compute the final warping matrix and use it to reproject the source image, as shown in Figure 2, we propose a pipeline consisting of three stages named initialization, joint optimization, and rendering and post-processing. In the first stage, we establish sparse correspondences between I s and I t and estimate the relative pose T rel between two views. Meanwhile, we obtain a dense depth map of the source image using a pretrained deep model. Then we align the scale and offset of the predicted depth map with the sparse 3D triangulated feature points. In the second stage, we mitigate the potential errors of the initial guess of pose and depth by optimizing the related parameters so contents well-align near the hole. Finally, we render the warped image using the optimized parameters, and post-process it to address any residual spatial and color misalignments like TransFill. We will introduce each stage in the following sections.

## Initialization Stage

Initialize Relative Pose Our approach first estimates the relative pose T rel based on predicted sparse correspondences. We extract sparse corresponding feature points P t and P s between the target and source images, and compute the fundamental matrix F between I s and I t via the normalized 8-point algorithm [22] using RANSAC [17]. From F, we derive the relative pose T rel using the classic multi-view geometry algorithm mentioned in [22].

# Initialize Dense Depth Map

We then predict the inverse depth map on the source image using a pretrained monocular depth estimator as the cues to estimate the real source depth. Mathematically, we only need the source depth and T rel to compute the 3D-aware warp I s→t . However, the source depth is predicted up to an unknown scale and offset by a pretrained deep model, therefore, we need to solve for these such that the initial source depth D i s best matches the estimated relative pose. Note the estimated translation in T rel is normalized and will not match the arbitrary scale in the predicted depth maps from pretrained deep models. As suggested in [73], aligning dense depth to sparse triangulated points is much simpler than rescaling the relative pose. Therefore, we first triangulate points with the relative pose, then align the scale of depth predictions with triangulation to subsequently match the scale of the relative pose. Specifically, a 3D triangulated point x with point q s ∈ P s and q t ∈ P t is computed as,

where r s represents the ray shooting from the source camera center through the point q s on the image plane, r t is the ray from the target camera following a similar analogy, and E measures the Euclidean distance between two inputs. In this way, we compute a set of 3D triangulated points X using all matching sparse correspondences. In order to form the linear problem to compute the scale and offset, we first compute a sparse triangulated depth map D tri by projecting 3D triangulated points to source camera coordinates. Note D tri is in the same scale as the relative pose. Therefore, we correct D s to match D tri , which subsequently matches the scale of the relative pose. We correct D s by estimating two scalars, the scale s i and offset b i associated with the depth map, by solving a linear least square problem. The initial depth maps are then expressed as:

## Joint Optimization Stage

To mitigate the effects of potential errors in sparse correspondence and depth estimation since deep models can be not robust or generalized enough, we further introduce an optimization module to improve the quality of I s→t . We optimize the depth scale, offset, and the relative pose that jointly define I s→t in the 3D scene. Specifically, we convert the rotation matrix into quaternions, which leads to a total of 9 parameters to optimize. Both relative pose and the initial depth computed in the previous section are used as the initial guess for the optimization. Our optimization contains 3 different loss functions: a multiscale photometric loss L photo , a feature correspondence loss L feat , and a negative depth penalty L negD .

Multiscale Photometric Loss L photo measures the pixel-level color difference between I s→t and the I t outside the hole region. We downsample both I s→t and I t and sum the normalized color difference across different resolutions. Specifically, we build Gaussian pyramids on both I s→t and I t using an RGB representation for the source image and an alpha-premultiplied RGBA representation on the target image to incorporate the hole region properly into the target image. Computing a multi-scale photometric loss within each iteration is obviously computationally expensive. Moreover, the optimization might also get trapped into the local minima associated with the finest resolution due to poor initialization [81]. To accelerate the computation speed and find better solutions, we adopt a coarse-to-fine optimization strategy, which means we first compute photometric loss on the most coarse level and move to the finer level once the convergence criteria at the current pyramid level are met. Additionally, instead of building a 3D triangle mesh and rendering from the target view at each iteration, we use a much more efficient differentiable 3D reprojection to find a warping field that computes I s→t from I s with bilinear interpolation. Mathematically, we have:

where reproj() represents the reprojection operation. The photometric loss at a given resolution with the pyramid is:

Here W is a pixel importance weight map discussed shortly.

Feature Correspondence Loss L feat computes the distance between reprojected matching feature points in the source images and the target images. We use the reproj() operator on all 2D image coordinates in P s to get another set P s→t . Then, we compute the average distance between P s→t and P t . However, the average distance of all points is very sensitive to outliers, i.e., very few outliers dominate the loss function. To reduce the effects of the outliers on the loss function, we adopt the general robust loss function from [4]. The general form of the loss function is:

where α and c are the shape and scale parameters, respectively. In our experiments, we set α = -2 and c = 10. Then, feature correspondence loss is written as:

where f is the general robust loss function, q m s→t and q m t is the m th point in P s→t and P t , respectively.

Negative Depth Penalty L negD aims to penalize negative values in the remapped depth. Although depth predictions have arbitrary scale and offset, they should have all positive values, meaning that a fragment of geometry associated with a pixel should never move behind the camera. Mathematically, we adopt a hinge loss function:

Our final objective function is written as: l = λ 1 L photo + λ 2 L feat + λ 3 L negD , where {λ j } are weights. The convergence criteria is discussed in the supplemental material. Pixel Importance Weight Map W. When computing the photometric loss or feature correspondence loss, we assign weights to each pixel to replace uniform weighting. It encourages our optimization to better align the warped source with the target image both locally and globally.

The first type of weighting strategy is hole-distance weighting W h . We encourage the optimization to focus on the regions close to the hole boundary since those pixels are more important for filling the hole regions. To achieve this, we apply the distance transform to the hole image and obtain a distance map M h , where each pixel records the Euclidean distance to the closest boundary pixel of the hole M h . We compute the weight at each pixel using a Gaussian function

, where σ is a hyperparameter that adjusts how weights change w.r.t distance to the hole boundary.

The second type is the edge-based weighting W e . This is because high-gradient edge regions are more salient while checking the alignment quality so we intend to give strong edges larger weights. We compute a multi-scale Canny edge map by first applying Gaussian blur on I t with N different kernel sizes, running the Canny edge detector [10], and dilating each edge to get {e 1 , e 2 , • • • , e N }. Our pixel-level edge-based weight map becomes W e = N k=1 e k / p e k (p), where the inner sum is over spatial coordinates. Our overall weighting map is W = W h ⊙ W e .

## Rendering and Postprocessing Stage

Mesh Rendering. After optimization, we find T o rel , s o , and b o , the camera relative pose and depth map scale and offset, respectively. However, computing I s→t using depth reprojection always has some gaps between valid pixels due to it relying on a forward warping for efficiency in the inner loop of the optimization. One way to overcome this problem is interpolation but that has two disadvantages. First, the reprojected image is sparse and for regions with multiple layers of depth, pixels for a far-away depth layer might splat between pixels of a closer depth layer, which could result in interpolations that do not fully remove hidden surfaces. Additionally, interpolation cannot distinguish between holes due to disoccluded regions or simple gaps between the pixels due to the forward warping.

To address the above problems, we choose to render a textured mesh to get the final I s→t . We first build a triangle mesh with a regular grid from the source view. The mesh vertices are computed by projecting the optimized depth D o s to the 3D space and the texture is the RGB colors of the source image. After obtaining the mesh, we drop the edges around depth discontinuities. We adopt a simplified version of the footprint algorithm [56] by comparing the depth values between connected vertices. We drop the edge between two vertices v i and v j if

is the depth value of the vertex v i and ϵ edge is a predefined threshold. After building the triangle mesh, we render the target view with T o rel . Note that we also normalize the mesh to the unit size before rendering. The textured mesh densely fills in pixels and removes hidden surfaces. It also allows us to use the rendered alpha channel to find pixels where there is no ray intersection with the mesh, which represent disoccluded regions near depth discontinuities or regions outside the photo: these are later filled by single image inpainting. We use PyTorch3D [46] as our renderer.

Refinement and Merging. With the rendered image, we apply the color-spatial transformation (CST) module from TransFill to further improve any small residual spatial misalignments and correct color and exposure differences. Lastly, we merge the output from CST with results from the single image inpainting model as in TransFill to handle the disocclusions and regions outside the photo.

# Datasets.

No large-scale image-based dataset for reference-based inpainting is available. So we follow Trans-Fill to randomly sample multiple image pairs from videobased datasets because it is easier to simulate user behaviours and analyze the target-source difference (or camera view changes). During evaluation we only use one single reference frame. This is different from what video inpainting works did. We follow DeepFillv2 [66] to generate random free-form brush stroke masks and evaluate GeoFill and other baselines on the following datasets. RealEstate10K [79]: It contains a diverse collection of YouTube video sequences shot from a moving camera for both indoor and outdoor scenes. Each video clip contains a variety of views of the same scene. We randomly sample 500 videos and select one pair of images in each video sequence with a specific frame difference (FD). Specifically, we sample FD=25, 50, and 75 to build three different sets with a resolution of 720×1280 while automatically filtering out image pairs without enough overlapping content inside the hole by checking the number of matching sparse features. Note that our filtering mechanism is only for the purpose of simulating user behaviors and removing non-useful image pairs. In practice, we believe users could simply check overlap between photos by visual inspection. MannequinChallenge [30]: This is a challenging dataset with video sequences shot from a hand-held camera freely roaming in a scene of people with frozen poses. This dataset contains more than 170K frames and corresponding camera poses derived from about 2k YouTube videos. The camera motion in this dataset is more extreme and scene complexity is much higher due to diverse frozen human poses and rich background objects. We reduce the sampling FD to ensure enough overlap between image pairs. Similar to the previous dataset, we randomly sample 3 subsets with FD=10, 20, 30, where each contains 500 image pairs of 720 × 1280. Real User-provided Images: We also evaluate our approach on the real user-provided images like TransFill to validate the generalization ability and practicability.

Baselines. In addition to TransFill, which is directly related to our work, we compare our approach against several different types of baselines to evaluate final inpainting performance. The first type is state-of-the-art video completion models. OPN [40] achieves high quality inpainting results with spatio-temporal attention. STTN [67] proposes to optimize a spatial-temporal adversarial loss function. In addition, we compare against state-of-the-art single-image inpainting methods including ProFill [68] and CoModGAN [72]. We use their off-the-shelf pretrained weights directly since they are both trained on more diverse scenes in Places2 [77] than RealEstate10K and have strong generalization ability. Lastly, we compare a two-view SfM based approach [73] -which we refer to as JointDP -by warping the source image with the jointly estimated relative pose and depth using dense correspondence. To ensure fairness in the comparison, we use the same depth predictor and rendering process as in GeoFill while keeping all other settings the same as in the original work.

Implementation Details. We follow TransFill to extract SIFT features [35] and feed them into OANet [69] to reject outliers and establish correspondences. This combination was already proven to be quite robust. A better matching strategy could always be adopted to further improve results while leaving the rest of our framework intact. Our pretrained monocular depth predictor is DPT [44]. No groundtruth camera intrinsic information is required to run our approach. We use fixed camera intrinsic parameters for all images by setting focal length to 750 and principal point to the image center. An ablation study with different focal lengths is included in the supplemental material. We use the pretrained CST module from TransFill [80] without finetuning. This module generalizes well to Mannequin-Challenge and user provided images. Our pipeline is implemented with PyTorch [41] and we choose DiffGrad [15] as our optimizer due to its fast convergence speed. In the optimization step, we use a constant learning rate 10 -2 and the maximum number of iteration is set to 10 4 . The loss weights λ 1 , λ 2 , and λ 3 are 10, 10, 0.5, respectively. In the coarse-to-fine optimization strategy, the number of pyramid levels is 4 and the maximum number of cumulative iterations at each level from coarse to fine are 4 × 10 3 , 7 × 10 3 , 9 × 10 3 , 10 4 . We set the σ in hole-based weighting to 192 pixels. In edge-based weight, we compute 4 different Canny edge maps and dilate each of them with a kernel size equal to 4. In mesh rendering, the edge threshold ϵ edge is 4×10 -2 .

## Quantitative Results

The quantitative results comparing our approach with other baselines are shown in Table 1. We report the PSNR, SSIM and LPIPS [71] on the RealEstate10K and the Man-nequinChallenge datasets. Single image inpainting models are not competitive enough for image pairs with larger scale differences and wider baselines. Video inpainting approaches also show bad performance due to the lack of dense temporal information and multiple reference frames. JointDP is based on optical flow and is not able to accurately estimate parameters like the camera pose needed to correctly align the image pairs. Our method demonstrates superiority over TransFill because we have a better under- 

## Qualitative Results

Figure 3 shows the visual comparisons with other baseline algorithms on the user-provided images, the RealEstate10K and the MannequinChallenge dataset. JointDP utilizes estimated optical flow for the initial matching, thus the results fail to obtain accurate depth and camera pose if the baseline of the image pair is wide. The contents inside the hole are often misaligned with the target image. The original OPN uses five reference frames to achieve a more efficient non-local matching among frames, but a single reference frame makes the results less visually-pleasing. ProFill is not able to take advantage of the reference image contents, and TransFill usually has blending artifacts or content misalignment issues when objects inside the hole regions occupy multiple depth planes. However, GeoFill avoids the blending artifacts by using one single proposal, and aligns the objects well by understanding the camera poses and reconstructing the 3D scene from two images.

## Ablation Study

In the following sections, we study how each optimization loss function and the pixel importance weight maps contribute to the final results. Additionally, we present experimental results of TransFill and GeoFill on cases with larger holes and their alignment accuracy without CST. All experiment results in the following section are reported for the RealEstate10K FD=50 subset unless specified. We also include more in-depth analyses of the joint depth pose optimization module on RealEstate10K and ScanNet [12], the timing of each module in our system pipeline, the convergence criteria of the optimization step, and more visualizations in the supplemental material. Optimization: Objective Functions. We claim that all the objective functions used in the optimization process contribute to a higher perceptual and reconstruction quality as shown in Table 2. Comparing GeoFill without photometric loss against without feature correspondence loss, the feature loss contributes to the performance the most. We find that photometric loss by itself may get distracted by local textures and fall into local minima, such that it achieves lower RGB errors on average but ignores the global structure. However, using the photometric loss does help improve alignments. Lastly, GeoFill without negative depth penalty still has a performance drop, suggesting negative depth penalty is able to prevent corner cases where depth scale or offset estimates are non-robust.

Optimization: Pixel Importance Weight Map. We present results of GeoFill with different combinations of pixel importance weight maps in the optimization in Table 3. This suggests that hole-distance weighting W h which puts higher weights around the hole lead to better local alignment around the hole. Edge-based weighting W e also helped by matching strong edges within the image. Using a uniform weighting map leads to the worst performance, indicating the effectiveness of the weighting maps.

Performance w.r.t Hole Size. This ablation study aims to examine the performance of our approach against Trans-Fill under more difficult settings. As the hole becomes larger, inevitably we have fewer matching points, which makes I s→t hard to align with I t . We generate holes with different average stroke widths ranging from 90 to 210 pixels. As shown in Figure 4, GeoFill has an increasing performance gain over TransFill until the hole average stroke width reaches 180 pixels. As the hole size grows, the complexity of the content in the hole also increases. In other words, we are more likely to encounter a growing number  of depth layers, a more complicated objects layout, and a higher chance of occlusions due to camera translation in a larger hole. These problems are harder for homographybased models, therefore, GeoFill has a greater advantage when the hole is larger. The drop in performance gain at the end of the curve can be because there are not enough matching points for GeoFill to infer an accurate 3D structure. Initial Alignment Comparisons against TransFill. We adopted the CST module from TransFill to adjust auto exposure, lighting conditions, and potential remaining misalignments. In this experiment, we analyze the performance of using the aligned images directly, e.g. without using CST for both models. We retain the multiple homographies used by TransFill, drop the CST module, and keep the merging module so TransFill can merge its different regions. Table 4 shows that GeoFill maintains better performance, dropping 2.12 in PSNR, while TransFill drops 4.62 without CST. This experimentally validates the proposal from GeoFill is much more accurate than TransFill by better leveraging the depth.

Per-Sample Improvement Study. This ablation is designed to break down the numbers shown in Table 1 by comparing the performance of GeoFill against TransFill over each individual sample. We sort and plot the per-image PSNR difference over TransFill, shown in Figure 5. Specifically, PSNR difference is computed as GeoFill PSNR -TransFill PSNR, therefore a positive PSNR gain indicates GeoFill is better. GeoFill improves performance on the majority of samples, specifically for around 75.4% of the entire subset. Moreover, the PSNR gains when GeoFill outperforms are much greater: up to 3 dB, as opposed to the PSNR losses when TransFill outperforms.

# Discussion, Limitations, and Conclusion

Limitations and Future Work. GeoFill inpaints the hole with one image pair with no auxiliary pose or depth information from sensors, therefore, our pipeline may not work well when the quality of feature matching points is poor, e.g., matching points are inaccurate or too few. Under these cases, our relative pose and triangulated points can be inaccurate, which may be hard for optimization to correct. Additionally, our pipeline is also sensitive to depth prediction quality: artifacts such as blurry depth discontinuities or wrong order of depth planes can lead to potential bad inpainting results. Future work might mitigate these problems by jointly reasoning about monocular depth and the stereo cues established by triangulation. In the optimization, we used a 3D reprojection based on forward warping because it is much faster than rendering a triangle mesh even though it does not fully remove hidden surfaces in the rare cases where a mesh occludes itself: this could be addressed in future work by testing and pruning those splatted points. GeoFill utilizes the CST module to adjust auto exposure and lighting condition changes, which still suffers when the scene environment changes drastically, e.g., day to night, spring to fall. Future work could better address these by incorporating specialized lighting estimation (e.g., [70]) and relighting modules. One last limitation of GeoFill is that our pipeline only handles static scenes. Any dynamic objects, e.g., walking people or moving cars, not in the hole could lead to bad relative pose estimation and our optimization may cause misalignments under such cases. A simple solution would be masking out objects that are likely to move such as people and cars, but how to correctly identify all moving objects is still an open question.

Conclusion. In this work, we proposed a novel reference-based inpainting approach that achieves state-ofthe-art performance. Our method relies on off-the-shelf depth estimation and sparse correspondence methods, and thus we can expect its performance to improve if these modules improve in performance. Compared to previous homography-based work, GeoFill is better at image pairs with large camera motions and scenes with complicated structures in the hole. GeoFill ensures accurate alignment between the filling content and the hole by jointly optimizing depth predictions and relative poses without explicitly knowing camera intrinsics. Moreover, our approach inpaints the hole in a more principled way by utilizing a single proposal without heuristic planar assumptions.

# Appendices

In the supplementary document, we provide additional ablation studies to further support our findings, as well as details of our experiments and more visualizations. Below is the outline.

• Section A: Convergence criteria. We describe the convergence criteria of our optimization step in detail. • Section B: Joint optimization evaluation: inpainting performance. We demonstrate the importance of the joint optimization module by comparing the performance of GeoFill with parameters estimated before and after the joint optimization. • Section C: Joint optimization evaluation: depth and pose accuracy. We further evaluate the performance of the optimization module by measuring the accuracy of depth maps and camera poses individually against ground-truth using ScanNet. • Section D: Performance w.r.t intrinsic parameters.

Quantitative comparisons of our approach with different focal lengths. • Section E: Further analyses of initial alignments. We provide additional qualitative and quantitative evaluations of GeoFill and TransFill without the CST module. • Section F: Visualizations of hole ablation study. We include qualitative comparisons between GeoFill and TransFill under various hole sizes. • Section G: Average running time of GeoFill. We report the average running time of each step in GeoFill. • Section H: User study against other baselines. A user study of GeoFill against OPN, ProFill, and TransFill. • Section I: Handling appearance changes from camera movement. We show qualitative results of GeoFill handling some common appearance changes due to camera movement. • Section J: Failure cases. Visual examples of failure cases of GeoFill. • Additional Visual Results. We include more inpainting results in Fig. 11 and12.

# A. Convergence Criteria

The convergence criteria define when the optimization should stop. Our optimization halts the loop at a given scale and continues to the next scale if the following condition is met or the predefined maximum number of iteration is achieved. The formula below measures the objective function value changes within the last m iterations.

where i represents the i th iteration. If ϵ i is smaller than a predefined ϵ opt , we assume the objective function has con-verged. Since we adopt a coarse-to-fine optimization strategy, we check the same condition at every level of the pyramid. In other words, we move to the finer scale level only if Eqn. 7 is met or maximum number of iterations at the current level is reached. We also keep track of the optimal parameters at each level and use them as the initialization in the next level. In practice, we set the convergence threshold ϵ opt to 10 -6 for all levels. The number of loss values to track in computing convergence criteria is m = 10.

# B. Joint Optimization Evaluation: Inpainting Performance

We show the importance of our optimization module by comparing the performance of GeoFill with initial estimated parameters and optimized parameters. As shown in Table 5, GeoFill with optimized parameters has substantially better performance. Initial parameters are computed from SIFT and pretrained models such as OANet, which can make erroneous predictions, especially for image pairs with holes. Experimental results demonstrate our optimization module successfully mitigates such errors and improves the inpainting performance.

# C. Joint Optimization Evaluation: Depth, Pose Accuracy

In this section, we further demonstrate the effectiveness of our joint optimization step by measuring the depth and pose accuracy before and after the optimization. Since both RealEstate10K and MannequinChallenge do not have ground-truth labels, we choose the ScanNet [12] dataset which comes with ground-truth camera poses and depth maps. We randomly sampled 75 pairs of images with approximately 30 frame difference. We generate random holes in the same manner as described in our main paper line 388. Each image pair comes from a unique scene in the dataset. Note that ScanNet includes images with heavy motion blur, which we manually filtered out. We evaluate depth and relative camera pose separately by providing the ground-truth for one of these (depth or camera pose) when evaluating the accuracy of the other one. For example, when evaluating the accuracy of depth maps, we first follow the same pipeline described in the main paper. Then, instead of estimating the relative pose, we provide the ground-truth camera pose and evaluate the accuracy of the depth map determined by our pipeline before and after the optimization. Note that we only optimize scale and offset when evaluating depth accuracy. A similar analogy applies when evaluating the accuracy of camera poses: we provide the ground truth depth map to our pipeline and then evaluate the accuracy of the relative pose before and after optimization. For pose evaluation, we report the geodesic errors [11] for both rotations and translation directions. For depth eval-  uation, we follow the commonly adopted metrics used in the literature [16,18]. As shown in Table 6 and Table 7, both depth and pose errors are significantly reduced after the optimization module, which demonstrates the ability of the optimization module to find more accurate depth and poses in our challenging case where the images have holes.

# D. Performance w.r.t Intrinsic Parameters

GeoFill handles incoming image pairs using fixed camera intrinsic parameters instead of explicitly knowing the ground-truth camera intrinsic parameters. In the main paper, we use fixed camera intrinsic parameters by setting the focal length of all images to 750 pixels and the principal point to the center of the image. It is intuitive to set the principal point to the center of the images with unknown intrinsic parameters, therefore, we focus on studying the effect of focal lengths. We compare the performance of GeoFill with the camera focal lengths of 600, 750, 900, 1050, and 1200 pixels. As shown in Fig. 6, GeoFill with different focal lengths has very slight differences in terms of PSNR. There is a slight trend that the performance drops as the focal length increases. We believe this indicates that the ground-truth focal length is close to 600 and higher focal lengths make the optimization have a harder time finding improved relative poses. Nevertheless, GeoFill can still adapt to different focal lengths by jointly optimizing depth scale, offset, and relative pose, therefore, it still can render similar images across a variety of focal lengths.

# E. Further Analyses of Initial Alignments

GeoFill adopts the CST module from TransFill to further improve any small residual spatial misalignments and correct color and exposure differences. We first visually compare the quality of our single proposal to the merged proposal from TransFill without the CST on RealEstate10K dataset. As shown in Fig. 8, the single proposal from Ge-oFill is significantly more accurate than merged heuristic proposals from TransFill, demonstrating the superiority of our approach over TransFill. Additionally, we also show the quantitative comparisons of GeoFill and TransFill without the CST module on the MannequinChallenge dataset. As shown in Table 8, we find GeoFill without the CST module has a huge advantage over TransFill merged homographies.

# F. Visualizations for Hole Ablation Study

In the main paper, we show the quantitative comparisons between our approach and TransFill with various hole sizes. Here, we provide visual comparisons to better understand the performance boost for larger holes. We simulate larger holes by generating the same hole shape with larger stroke width. As shown in Fig. 7, GeoFill has a robust performance while TransFill has ghosting artifacts and misalignments as the hole grows larger.

# G. Average Running Time of GeoFill

We randomly sampled 50 images at 1280x720 pixels and compute the average time of each step. Monocular depth estimation takes 3.83s, sparse correspondence estimation takes 0.596s, triangulation takes 0.0009s, initial relative pose takes 0.0052s, joint optimization takes 58.2s, mesh rendering takes 1.03s, refinement and merging step takes 2.53s. The reported time uses default parameters described in the experiment section. Although the joint optimization step takes up the vast majority of the time, its current implementation is naive and not optimized. If desired, various engineering optimizations could be made such as using a custom kernel with proper low-level optimizations such as fusion for the renderer instead of a naive pure PyTorch implementation, using FP16 mode, using only the sparse edge map pixels during optimization (these are quite sparse so significant acceleration should be possible), using secondorder optimization techniques that could potentially converge in fewer steps, carefully tuning input resolution, number of pyramid levels, iteration limits, break thresholds, etc. We considered these to be lower-level engineering details that we did not focus on in our paper's implementation, since we were focusing more on research aspects.

# H. User Study

To better evaluate the performance of GeoFill against other baselines, we conduct a user study via Amazon Mechanical Turk (AMT). We compare our method against OPN, ProFill, and TransFill by showing users image pairs with binary choice questions. The users are requested to choose the inpainting results that look more realistic and faithful. To improve the quality of collected data, we adopt a qualification test with trivial questions to filter noisy results. For each method pair, we randomly sampled 80 examples in RealEstate10K dataset with FD=50, and each example was evaluated by 7 independent users. We present two approaches to computing the preference rate. The first one is the filtered approach, in which we filter the responses to retain only those where one method is "preferred" if 6 or more users select it. The filtering helps suppress noise in the responses of Mechanical Turk workers, whose work  quality can vary. The second one is the non-filtered approach where we retain all responses and choose the method as "preferred" where a simple majority of 4 or more users select it. We reported GeoFill's Preference Rate (PR) in Table 9. GeoFill has much higher preference rates against OPN and ProFill. Compared against TransFill, we receive a PR around 70% on filtered and non-filtered approaches.

TransFill is still very robust on small holes and relatively small camera motions in the randomly sampled data. Therefore, GeoFill is favored by users over TransFill but less strongly than in the other comparisons. We performed a one sample permutation t test with 10 6 simulations using the null hypothesis that each pair are preferred equally by users: the p-values are all sufficiently small that the preference for our method is statistically significant.

# I. Handling Appearance Changes from Camera Movement

As we stated in the main paper, we focus on the common scenario of capturing photos with the same camera freely moving around. However, there are potential appearance changes of the same parts of the scene due to the camera movement, for example, changes due to automatic exposure or automatic white balance between source and target images. This is a common yet non-trivial challenge when applying GeoFill in real-world applications. In this section, we show some visual examples of image pairs with appearance changes in the dataset. As shown in Figure 10, GeoFill still inpaints plausible results even when the appearance of the same part of the scene is different between source and target images.

# J. Failure Cases

We show some failure cases of GeoFill under extreme conditions. Fig. 9 shows three common failure cases of Ge-oFill. The image pair on the left contains transparent surfaces in the images. These objects often cause monocular depth estimators to fail and can lead to bad optimization results. In the second failure case, the drastic changes in the lighting environment affect the feature correspondence matching and depth prediction, which makes the final result from GeoFill less accurate. In the last case, dynamic objects, e.g., pedestrians, make our optimization module estimate inaccurate parameters. We discuss in the last section of our main paper ways that future work might address these issues.

# Additional Visual Results

We include additional qualitative comparisons of Ge-oFill against other baselines in Fig. 11. Additionally, we also show the inpainting performance of GeoFill on userprovided images, RealEstate10K, and MannequinChallenge dataset in Fig. 12.  

